name: Build Act Worker Image

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - Dockerfile
      - .github/workflows/build.yml

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
      - name: Build and push
        run: |
          docker buildx create --use --driver docker-container
          docker buildx build \
            -t ghcr.io/mikemol/act-ubuntu-agda:latest \
            --cache-from type=registry,ref=ghcr.io/mikemol/act-ubuntu-agda:buildcache \
            --cache-to type=registry,ref=ghcr.io/mikemol/act-ubuntu-agda:buildcache,mode=max \
            --push .
